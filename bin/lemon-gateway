#!/bin/bash
#
# lemon-gateway - Launch Lemon's Telegram runtime from source.
#
# Usage:
#   ./bin/lemon-gateway [--debug]
#
# Reads configuration from:
#   ~/.lemon/config.toml
#   <project>/.lemon/config.toml (if you run from a project directory)
# Also loads:
#   <launch_dir>/.env (can be overridden by setting LEMON_DOTENV_DIR)
#
set -e

LAUNCH_CWD="$(pwd)"

SCRIPT_PATH="${BASH_SOURCE[0]}"
while [ -L "$SCRIPT_PATH" ]; do
  SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
  SCRIPT_PATH="$(readlink "$SCRIPT_PATH")"
  [[ "$SCRIPT_PATH" != /* ]] && SCRIPT_PATH="$SCRIPT_DIR/$SCRIPT_PATH"
done

SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
LEMON_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

export LEMON_PATH="$LEMON_ROOT"

DEBUG=""
while [[ $# -gt 0 ]]; do
  case $1 in
    --debug)
      DEBUG="1"
      shift
      ;;
    --help|-h)
      echo "Usage: ./bin/lemon-gateway [--debug]"
      exit 0
      ;;
    *)
      echo "Unknown option: $1" >&2
      echo "Usage: ./bin/lemon-gateway [--debug]" >&2
      exit 1
      ;;
  esac
done

cd "$LEMON_ROOT"

if [[ -n "$DEBUG" ]]; then
  export LEMON_DEBUG=1
fi

export LEMON_DOTENV_DIR="${LEMON_DOTENV_DIR:-$LAUNCH_CWD}"

mix deps.get
mix compile

echo "[lemon-gateway] Starting Telegram runtime (Ctrl-C to stop)..."
# Telegram polling and delivery are owned by lemon_channels (Telegram adapter + outbox),
# while run orchestration lives in lemon_router and execution lives in lemon_gateway.
# `--no-start` is important in umbrella projects: it prevents Mix from starting every
# OTP application in the umbrella (e.g. the control plane on :4040) implicitly.
exec mix run --no-start --no-halt -e 'LemonCore.Dotenv.load_and_log(System.get_env("LEMON_DOTENV_DIR")); Application.ensure_all_started(:lemon_gateway); Application.ensure_all_started(:lemon_router); Application.ensure_all_started(:lemon_channels)'
