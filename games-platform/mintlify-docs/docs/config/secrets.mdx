---
title: Encrypted Secrets
description: 'Secure storage for API keys and credentials'
---

Lemon includes an encrypted local secrets store for API keys and credentials.

## Features

- **AES-256-GCM encryption** at rest
- **Plaintext never returned** by list/status APIs
- **macOS Keychain integration** for master key
- **Fallback to environment variable**

## Initialize

### macOS (Keychain - Recommended)

```bash
mix lemon.secrets.init
```

This stores the master key in your macOS Keychain.

### Fallback (Environment Variable)

```bash
# Generate a 32-byte base64 key
export LEMON_SECRETS_MASTER_KEY="$(openssl rand -base64 32)"
```

### Master Key Resolution

1. Keychain (macOS)
2. `LEMON_SECRETS_MASTER_KEY` environment variable

## Store Secrets

```bash
# Set a secret
mix lemon.secrets.set llm_openai_api_key "sk-..."

# With metadata
mix lemon.secrets.set github_api_token "ghp_..." \
  --provider github \
  --expires-at 1735689600000
```

## List Secrets

```bash
# List metadata only (never plaintext)
mix lemon.secrets.list

# Output:
# NAME                    PROVIDER    CREATED_AT           EXPIRES_AT
# llm_openai_api_key      openai      2024-01-15T10:30:00Z -
# github_api_token        github      2024-01-15T10:35:00Z 2025-01-01T00:00:00Z
```

## Check Status

```bash
mix lemon.secrets.status

# Output:
# Key source: keychain
# Secrets count: 2
```

## Delete Secrets

```bash
mix lemon.secrets.delete llm_openai_api_key
```

## Use in Config

Reference secrets in `~/.lemon/config.toml`:

```toml
[providers.openai]
api_key_secret = "llm_openai_api_key"

[providers.anthropic]
api_key_secret = "llm_anthropic_api_key"
```

## Resolution Order

When a provider needs an API key:

1. Provider environment variable (e.g., `OPENAI_API_KEY`)
2. Plain `api_key` in config
3. `api_key_secret` from encrypted store
4. Default secret name fallback: `llm_<provider>_api_key`

### Default Secret Names

| Provider | Default Secret Name |
|----------|---------------------|
| OpenAI | `llm_openai_api_key` |
| Anthropic | `llm_anthropic_api_key` |
| OpenAI Codex | `llm_openai_codex_api_key` |
| Google | `llm_google_api_key` |

## WASM Tool Credentials

WASM tools can use secrets for HTTP authentication:

```json
{
  "secrets": {
    "allowed_names": ["github_api_token"]
  },
  "http": {
    "credentials": {
      "github_auth": {
        "secret_name": "github_api_token",
        "host_patterns": ["api.github.com"],
        "location": {
          "type": "header",
          "name": "Authorization",
          "prefix": "Bearer "
        }
      }
    }
  }
}
```

Store the secret:

```bash
mix lemon.secrets.set github_api_token "ghp_..."
```

The host injects credentials during `http-request` based on capabilities. The secret value is resolved at the host boundary and is not exposed in WASM `execute` params/context.

## Control Plane Methods

The control plane exposes these methods:

| Method | Access | Description |
|--------|--------|-------------|
| `secrets.status` | Read | Get key source and count |
| `secrets.list` | Read | List secret metadata |
| `secrets.exists` | Read | Check if secret exists |
| `secrets.set` | Admin | Create/update secret |
| `secrets.delete` | Admin | Delete secret |

`secrets.list` and `secrets.status` return metadata only; plaintext values are never returned.
