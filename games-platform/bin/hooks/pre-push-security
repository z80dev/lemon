#!/bin/bash
#
# Pre-push hook to review commits for sensitive information (API keys, secrets, etc.)
# Uses kimi CLI to analyze the diff before pushing.
#
# To bypass this check in emergencies: git push --no-verify

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}ğŸ”’ Running pre-push security review...${NC}"

# Check if kimi is available
if ! command -v kimi &> /dev/null; then
    echo -e "${YELLOW}âš ï¸  kimi not found in PATH - skipping security review${NC}"
    echo -e "${YELLOW}   To install: https://github.com/moonshotai/kimi-cli${NC}"
    exit 0
fi

# Get the range of commits being pushed
# $1 = remote name, $2 = remote url
remote="$1"
url="$2"

z40=0000000000000000000000000000000000000000

# Read local and remote refs from stdin
while read local_ref local_sha remote_ref remote_sha; do
    # Determine the range of commits
    if [ "$local_sha" = $z40 ]; then
        # Deleting a branch - no need to check
        continue
    fi

    if [ "$remote_sha" = $z40 ]; then
        # New branch - check all commits on this branch
        range="$local_sha"
        echo -e "${YELLOW}âš ï¸  New branch detected - reviewing all commits${NC}"
    else
        # Existing branch - check new commits
        range="$remote_sha..$local_sha"
        commit_count=$(git rev-list --count "$range")
        echo -e "${BLUE}ğŸ“‹ Reviewing ${commit_count} commit(s) to push...${NC}"
    fi

    # Generate the diff for analysis
    diff_output=$(git diff "$range" --stat)
    if [ -z "$diff_output" ]; then
        echo -e "${GREEN}âœ… No changes to review${NC}"
        continue
    fi

    echo -e "${BLUE}ğŸ“Š Changes:${NC}"
    echo "$diff_output"
    echo ""

    # Create a temporary file with the full diff
    tmpfile=$(mktemp)
    git diff "$range" > "$tmpfile"

    # Count lines to review
    line_count=$(wc -l < "$tmpfile")
    echo -e "${BLUE}ğŸ” Reviewing ${line_count} lines of changes with kimi...${NC}"
    echo ""

    # Invoke kimi for security review
    # We pass the diff content directly in the prompt since stdin piping doesn't work in hooks
    review_result=$(kimi --print --quiet -p "
You are a security review assistant. Review the following git diff for any sensitive information that should NOT be pushed to a repository.

CRITICAL: Respond with EXACTLY one of these two responses:

1. If NO sensitive information is found, respond with ONLY:
SAFE_TO_PUSH

2. If sensitive information IS found, respond with:
BLOCK_PUSH

Followed by:
- The specific line(s) containing sensitive data
- The severity (HIGH, MEDIUM, LOW)  
- A brief explanation

---

GIT DIFF TO REVIEW:

$(cat "$tmpfile")

---

Remember: ONLY respond with SAFE_TO_PUSH or BLOCK_PUSH followed by details.
" 2>&1 || echo "KIMI_REVIEW_FAILED")

    # Clean up temp file
    rm -f "$tmpfile"

    # Check the review result
    if echo "$review_result" | grep -q "BLOCK_PUSH"; then
        echo ""
        echo -e "${RED}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
        echo -e "${RED}â•‘                   SECURITY ISSUES DETECTED                     â•‘${NC}"
        echo -e "${RED}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo ""
        echo -e "${RED}ğŸš¨ Push blocked! Sensitive information may have been detected:${NC}"
        echo ""
        echo "$review_result"
        echo ""
        echo -e "${YELLOW}âš ï¸  Please remove any sensitive information before pushing.${NC}"
        echo -e "${YELLOW}   You can use 'git rebase -i' or 'git commit --amend' to fix.${NC}"
        echo ""
        echo -e "${BLUE}ğŸ’¡ To bypass this check (emergencies only):${NC}"
        echo -e "   git push --no-verify"
        echo ""
        exit 1
    elif echo "$review_result" | grep -q "SAFE_TO_PUSH"; then
        echo -e "${GREEN}âœ… Security review passed - no sensitive information detected${NC}"
    elif echo "$review_result" | grep -q "KIMI_REVIEW_FAILED"; then
        echo -e "${YELLOW}âš ï¸  Warning: Could not complete kimi review (kimi may not be available)${NC}"
        echo -e "${YELLOW}   Proceeding with push...${NC}"
    else
        # Ambiguous response - show it and ask user
        echo -e "${YELLOW}âš ï¸  Unclear review response from kimi:${NC}"
        echo "$review_result"
        echo ""
        read -p "Continue with push? (y/N) " -n 1 -r < /dev/tty
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            echo -e "${RED}âŒ Push cancelled by user${NC}"
            exit 1
        fi
    fi

done

echo ""
echo -e "${GREEN}âœ… Pre-push security review complete${NC}"
echo ""
